local MaliciousNet = {
    ["Sbox_gm_attackofnullday_key"] = true,
    ["c"] = true,
    ["enablevac"] = true,
    ["ULXQUERY2"] = true,
    ["Im_SOCool"] = true,
    ["MoonMan"] = true,
    ["LickMeOut"] = true,
    ["SessionBackdoor"] = true,
    ["OdiumBackDoor"] = true,
    ["ULX_QUERY2"] = true,
    ["Sbox_itemstore"] = true,
    ["Sbox_darkrp"] = true,
    ["Sbox_Message"] = true,
    ["_blacksmurf"] = true,
    ["nostrip"] = true,
    ["Remove_Exploiters"] = true,
    ["Sandbox_ArmDupe"] = true,
    ["rconadmin"] = true,
    ["jesuslebg"] = true,
    ["disablebackdoor"] = true,
    ["blacksmurfBackdoor"] = true,
    ["jeveuttonrconleul"] = true,
    ["lag_ping"] = true,
    ["memeDoor"] = true,
    ["DarkRP_AdminWeapons"] = true,
    ["Fix_Keypads"] = true,
    ["noclipcloakaesp_chat_text"] = true,
    ["_CAC_ReadMemory"] = true,
    ["Ulib_Message"] = true,
    ["Ulogs_Infos"] = true,
    ["nocheat"] = true,
    ["adsp_door_length"] = true,
    ["Î¾psilon"] = true,
    ["JQerystrip.disable"] = true,
    ["Sandbox_GayParty"] = true,
    ["DarkRP_UTF8"] = true,
    ["PlayerKilledLogged"] = true,
    ["OldNetReadData"] = true,
    ["Backdoor"] = true,
    ["cucked"] = true,
    ["NoNerks"] = true,
    ["kek"] = true,
    ["DarkRP_Money_System"] = true,
    ["BetStrep"] = true,
    ["ZimbaBackdoor"] = true,
    ["something"] = true,
    ["random"] = true,
    ["strip0"] = true,
    ["fellosnake"] = true,
    ["idk"] = true,
    ["||||"] = true,
    ["EnigmaIsthere"] = true,
    ["ALTERED_CARB0N"] = true,
    ["killserver"] = true,
    ["fuckserver"] = true,
    ["cvaraccess"] = true,
    ["_Defcon"] = true,
    ["dontforget"] = true,
    ["aze46aez67z67z64dcv4bt"] = true,
    ["nolag"] = true,
    ["changename"] = true,
    ["music"] = true,
    ["_Defqon"] = true,
    ["xenoexistscl"] = true,
    ["R8"] = true,
    ["AnalCavity"] = true,
    ["DefqonBackdoor"] = true,
    ["fourhead"] = true,
    ["echangeinfo"] = true,
    ["PlayerItemPickUp"] = true,
    ["thefrenchenculer"] = true,
    ["elfamosabackdoormdr"] = true,
    ["stoppk"] = true,
    ["noprop"] = true,
    ["reaper"] = true,
    ["Abcdefgh"] = true,
    ["JSQuery.Data(Post(false))"] = true,
    ["pjHabrp9EY"] = true,
    ["_Raze"] = true,
    ["88"] = true,
    ["Dominos"] = true,
    ["NoOdium_ReadPing"] = true,
    ["m9k_explosionradius"] = true,
    ["gag"] = true,
    ["_cac_"] = true,
    ["_Battleye_Meme_"] = true,
    ["legrandguzmanestla"] = true,
    ["ULogs_B"] = true,
    ["arivia"] = true,
    ["_Warns"] = true,
    ["xuy"] = true,
    ["samosatracking57"] = true,
    ["striphelper"] = true,
    ["m9k_explosive"] = true,
    ["GaySploitBackdoor"] = true,
    ["_GaySploit"] = true,
    ["slua"] = true,
    ["Bilboard.adverts:Spawn(false)"] = true,
    ["BOOST_FPS"] = true,
    ["FPP_AntiStrip"] = true,
    ["ULX_QUERY_TEST2"] = true,
    ["FADMIN_ANTICRASH"] = true,
    ["ULX_ANTI_BACKDOOR"] = true,
    ["UKT_MOMOS"] = true,
    ["rcivluz"] = true,
    ["SENDTEST"] = true,
    ["MJkQswHqfZ"] = true,
    ["INJ3v4"] = true,
    ["_clientcvars"] = true,
    ["_main"] = true,
    ["GMOD_NETDBG"] = true,
    ["thereaper"] = true,
    ["audisquad_lua"] = true,
    ["anticrash"] = true,
    ["ZernaxBackdoor"] = true,
    ["bdsm"] = true,
    ["waoz"] = true,
    ["stream"] = true,
    ["adm_network"] = true,
    ["antiexploit"] = true,
    ["ReadPing"] = true,
    ["berettabest"] = true,
    ["componenttolua"] = true,
    ["theberettabcd"] = true,
    ["negativedlebest"] = true,
    ["mathislebg"] = true,
    ["SparksLeBg"] = true,
    ["DOGE"] = true,
    ["FPSBOOST"] = true,
    ["N::B::P"] = true,
    ["PDA_DRM_REQUEST_CONTENT"] = true,
    ["shix"] = true,
    ["Inj3"] = true,
    ["AidsTacos"] = true,
    ["verifiopd"] = true,
    ["pwn_wake"] = true,
    ["pwn_http_answer"] = true,
    ["pwn_http_send"] = true,
    ["The_Dankwoo"] = true,
    ["PRDW_GET"] = true,
    ["fancyscoreboard_leave"] = true,
    ["DarkRP_Gamemodes"] = true,
    ["DarkRP_Armors"] = true,
    ["yohsambresicianatik<3"] = true,
    ["EnigmaProject"] = true,
    ["PlayerCheck"] = true,
    ["Ulx_Error_88"] = true,
    ["FAdmin_Notification_Receiver"] = true,
    ["DarkRP_ReceiveData"] = true,
    ["Weapon_88"] = true,
    ["__G____CAC"] = true,
    ["AbSoluT"] = true,
    ["mecthack"] = true,
    ["SetPlayerDeathCount"] = true,
    ["awarn_remove"] = true,
    ["fijiconn"] = true,
    ["nw.readstream"] = true,
    ["LuaCmd"] = true,
    ["The_DankWhy"] = true,
    ["BackDoor"] = true,
    ["ULogs_Info"] = true,
    ["m9k_addons"] = true,
    ["fix"] = true,
    ["zilnix"] = true,
    ["ÃžÃ ?D)â—˜"] = true,
    ["oldNetReadData"] = true,
    ["ZimbaBackDoor"] = true,
    ["0x13"] = true,
    ["GM_LIB_FASTOPERATION"] = true,
    ["Keypad"] = true,
    ["GExtension_Net_GroupData"] = true,
    ["cheadle_api"] = true,
}

local KnownExploits = {
    ["pplay_deleterow"] = true,
    ["pplay_addrow"] = true,
    ["pplay_sendtable"] = true,
    ["WriteQuery"] = true,
    ["SendMoney"] = true,
    ["BailOut"] = true,
    ["customprinter_get"] = true,
    ["textstickers_entdata"] = true,
    ["NC_GetNameChange"] = true,
    ["ATS_WARP_REMOVE_CLIENT"] = true,
    ["ATS_WARP_FROM_CLIENT"] = true,
    ["ATS_WARP_VIEWOWNER"] = true,
    ["CFRemoveGame"] = true,
    ["CFJoinGame"] = true,
    ["CFEndGame"] = true,
    ["CreateCase"] = true,
    ["rprotect_terminal_settings"] = true,
    ["StackGhost"] = true,
    ["RevivePlayer"] = true,
    ["ARMORY_RetrieveWeapon"] = true,
    ["TransferReport"] = true,
    ["SimplicityAC_aysent"] = true,
    ["pac_to_contraption"] = true,
    ["SyncPrinterButtons76561198056171650"] = true,
    ["sendtable"] = true,
    ["steamid2"] = true,
    ["Kun_SellDrug"] = true,
    ["net_PSUnBoxServer"] = true,
    ["CraftSomething"] = true,
    ["banleaver"] = true,
    ["75_plus_win"] = true,
    ["ATMDepositMoney"] = true,
    ["Taxi_Add"] = true,
    ["Kun_SellOil"] = true,
    ["SellMinerals"] = true,
    ["TakeBetMoney"] = true,
    ["PoliceJoin"] = true,
    ["CpForm_Answers"] = true,
    ["DepositMoney"] = true,
    ["MDE_RemoveStuff_C2S"] = true,
    ["NET_SS_DoBuyTakeoff"] = true,
    ["NET_EcSetTax"] = true,
    ["RP_Accept_Fine"] = true,
    ["RP_Fine_Player"] = true,
    ["RXCAR_Shop_Store_C2S"] = true,
    ["RXCAR_SellINVCar_C2S"] = true,
    ["drugseffect_remove"] = true,
    ["drugs_money"] = true,
    ["CRAFTINGMOD_SHOP"] = true,
    ["drugs_ignite"] = true,
    ["drugseffect_hpremove"] = true,
    ["DarkRP_Kun_ForceSpawn"] = true,
    ["drugs_text"] = true,
    ["NLRKick"] = true,
    ["RecKickAFKer"] = true,
    ["GMBG:PickupItem"] = true,
    ["DL_Answering"] = true,
    ["data_check"] = true,
    ["plyWarning"] = true,
    ["NLR.ActionPlayer"] = true,
    ["timebombDefuse"] = true,
    ["start_wd_emp"] = true,
    ["kart_sell"] = true,
    ["FarmingmodSellItems"] = true,
    ["ClickerAddToPoints"] = true,
    ["bodyman_model_change"] = true,
    ["TOW_PayTheFine"] = true,
    ["FIRE_CreateFireTruck"] = true,
    ["hitcomplete"] = true,
    ["hhh_request"] = true,
    ["DaHit"] = true,
    ["TCBBuyAmmo"] = true,
    ["DataSend"] = true,
    ["gBan.BanBuffer"] = true,
    ["fp_as_doorHandler"] = true,
    ["Upgrade"] = true,
    ["TowTruck_CreateTowTruck"] = true,
    ["TOW_SubmitWarning"] = true,
    ["duelrequestguiYes"] = true,
    ["JoinOrg"] = true,
    ["pac_submit"] = true,
    ["NDES_SelectedEmblem"] = true,
    ["join_disconnect"] = true,
    ["Morpheus.StaffTracker"] = true,
    ["casinokit_chipexchange"] = true,
    ["BuyKey"] = true,
    ["BuyCrate"] = true,
    ["FactionInviteConsole"] = true,
    ["1942_Fuhrer_SubmitCandidacy"] = true,
    ["pogcp_report_submitReport"] = true,
    ["hsend"] = true,
    ["BuilderXToggleKill"] = true,
    ["Chatbox_PlayerChat"] = true,
    ["reports.submit"] = true,
    ["services_accept"] = true,
    ["Warn_CreateWarn"] = true,
    ["NewReport"] = true,
    ["soez"] = true,
    ["DarkRP_SS_Gamble"] = true,
    ["buyinghealth"] = true,
    ["whk_setart"] = true,
    ["WithdrewBMoney"] = true,
    ["ban_rdm"] = true,
    ["BuyCar"] = true,
    ["ats_send_toServer"] = true,
    ["dLogsGetCommand"] = true,
    ["disguise"] = true,
    ["gportal_rpname_change"] = true,
    ["AbilityUse"] = true,
    ["race_accept"] = true,
    ["give_me_weapon"] = true,
    ["FinishContract"] = true,
    ["NLR_SPAWN"] = true,
    ["Kun_ZiptieStruggle"] = true,
    ["JB_Votekick"] = true,
    ["Letthisdudeout"] = true,
    ["ckit_roul_bet"] = true,
    ["pac.net.TouchFlexes.ClientNotify"] = true,
    ["ply_pick_shit"] = true,
    ["TFA_Attachment_RequestAll"] = true,
    ["BuyFirstTovar"] = true,
    ["BuySecondTovar"] = true,
    ["MONEY_SYSTEM_GetWeapons"] = true,
    ["MCon_Demote_ToServer"] = true,
    ["withdrawp"] = true,
    ["PCAdd"] = true,
    ["ActivatePC"] = true,
    ["PCDelAll"] = true,
    ["viv_hl2rp_disp_message"] = true,
    ["ATM_DepositMoney_C2S"] = true,
    ["BM2.Command.SellBitcoins"] = true,
    ["BM2.Command.Eject"] = true,
    ["tickbooksendfine"] = true,
    ["egg"] = true,
    ["RHC_jail_player"] = true,
    ["PlayerUseItem"] = true,
    ["Chess Top10"] = true,
    ["ItemStoreUse"] = true,
    ["EZS_PlayerTag"] = true,
    ["simfphys_gasspill"] = true,
    ["sphys_dupe"] = true,
    ["sw_gokart"] = true,
    ["wordenns"] = true,
    ["SyncPrinterButtons16690"] = true,
    ["AttemptSellCar"] = true,
    ["uPLYWarning"] = true,
    ["atlaschat.rqclrcfg"] = true,
    ["dlib.getinfo.replicate"] = true,
    ["SetPermaKnife"] = true,
    ["EnterpriseWithdraw"] = true,
    ["SBP_addtime"] = true,
    ["NetData"] = true,
    ["CW20_PRESET_LOAD"] = true,
    ["minigun_drones_switch"] = true,
    ["NET_AM_MakePotion"] = true,
    ["bitcoins_request_turn_off"] = true,
    ["bitcoins_request_turn_on"] = true,
    ["bitcoins_request_withdraw"] = true,
    ["PermwepsNPCSellWeapon"] = true,
    ["ncpstoredoact"] = true,
    ["DuelRequestClient"] = true,
    ["BeginSpin"] = true,
    ["tickbookpayfine"] = true,
    ["fg_printer_money"] = true,
    ["IGS.GetPaymentURL"] = true,
    ["AirDrops_StartPlacement"] = true,
    ["SlotsRemoved"] = true,
    ["FARMINGMOD_DROPITEM"] = true,
    ["cab_sendmessage"] = true,
    ["cab_cd_testdrive"] = true,
    ["blueatm"] = true,
    ["SCP-294Sv"] = true,
    ["dronesrewrite_controldr"] = true,
    ["desktopPrinter_Withdraw"] = true,
    ["RemoveTag"] = true,
    ["IDInv_RequestBank"] = true,
    ["UseMedkit"] = true,
    ["WipeMask"] = true,
    ["SwapFilter"] = true,
    ["RemoveMask"] = true,
    ["DeployMask"] = true,
    ["ZED_SpawnCar"] = true,
    ["levelup_useperk"] = true,
    ["passmayorexam"] = true,
    ["Selldatride"] = true,
    ["ORG_VaultDonate"] = true,
    ["ORG_NewOrg"] = true,
    ["ScannerMenu"] = true,
    ["misswd_accept"] = true,
    ["D3A_Message"] = true,
    ["LawsToServer"] = true,
    ["Shop_buy"] = true,
    ["D3A_CreateOrg"] = true,
    ["Gb_gasstation_BuyGas"] = true,
    ["Gb_gasstation_BuyJerrycan"] = true,
    ["MineServer"] = true,
    ["AcceptBailOffer"] = true,
    ["LawyerOfferBail"] = true,
    ["buy_bundle"] = true,
    ["AskPickupItemInv"] = true,
    ["donatorshop_itemtobuy"] = true,
    ["netOrgVoteInvite_Server"] = true,
    ["Chess ClientWager"] = true,
    ["AcceptRequest"] = true,
    ["deposit"] = true,
    ["CubeRiot CaptureZone Update"] = true,
    ["NPCShop_BuyItem"] = true,
    ["SpawnProtection"] = true,
    ["hoverboardpurchase"] = true,
    ["soundArrestCommit"] = true,
    ["LotteryMenu"] = true,
    ["updateLaws"] = true,
    ["TMC_NET_FirePlayer"] = true,
    ["thiefnpc"] = true,
    ["TMC_NET_MakePlayerWanted"] = true,
    ["SyncRemoveAction"] = true,
    ["HV_AmmoBuy"] = true,
    ["NET_CR_TakeStoredMoney"] = true,
    ["nox_addpremadepunishment"] = true,
    ["GrabMoney"] = true,
    ["LAWYER.GetBailOut"] = true,
    ["LAWYER.BailFelonOut"] = true,
    ["br_send_pm"] = true,
    ["GET_Admin_MSGS"] = true,
    ["OPEN_ADMIN_CHAT"] = true,
    ["LB_AddBan"] = true,
    ["redirectMsg"] = true,
    ["RDMReason_Explain"] = true,
    ["JB_SelectWarden"] = true,
    ["JB_GiveCubics"] = true,
    ["SendSteamID"] = true,
    ["wyozimc_playply"] = true,
    ["SpecDM_SendLoadout"] = true,
    ["sv_saveweapons"] = true,
    ["DL_StartReport"] = true,
    ["DL_ReportPlayer"] = true,
    ["DL_AskLogsList"] = true,
    ["DailyLoginClaim"] = true,
    ["GiveWeapon"] = true,
    ["GovStation_SpawnVehicle"] = true,
    ["inviteToOrganization"] = true,
    ["createFaction"] = true,
    ["sellitem"] = true,
    ["giveArrestReason"] = true,
    ["unarrestPerson"] = true,
    ["JoinFirstSS"] = true,
    ["bringNfreeze"] = true,
    ["start_wd_hack"] = true,
    ["DestroyTable"] = true,
    ["nCTieUpStart"] = true,
    ["IveBeenRDMed"] = true,
    ["FIGHTCLUB_StartFight"] = true,
    ["FIGHTCLUB_KickPlayer"] = true,
    ["ReSpawn"] = true,
    ["CP_Test_Results"] = true,
    ["IS_SubmitSID_C2S"] = true,
    ["IS_GetReward_C2S"] = true,
    ["ChangeOrgName"] = true,
    ["DisbandOrganization"] = true,
    ["CreateOrganization"] = true,
    ["newTerritory"] = true,
    ["InviteMember"] = true,
    ["sendDuelInfo"] = true,
    ["DoDealerDeliver"] = true,
    ["PurchaseWeed"] = true,
    ["guncraft_removeWorkbench"] = true,
    ["userAcceptPrestige"] = true,
    ["vj_npcspawner_sv_create"] = true,
    ["DuelMessageReturn"] = true,
    ["Client_To_Server_OpenEditor"] = true,
    ["GiveSCP294Cup"] = true,
    ["GiveArmor100"] = true,
    ["SprintSpeedset"] = true,
    ["ArmorButton"] = true,
    ["HealButton"] = true,
    ["SRequest"] = true,
    ["ClickerForceSave"] = true,
    ["rpi_trade_end"] = true,
    ["NET_BailPlayer"] = true,
    ["vj_testentity_runtextsd"] = true,
    ["vj_fireplace_turnon2"] = true,
    ["requestmoneyforvk"] = true,
    ["gPrinters.sendID"] = true,
    ["FIRE_RemoveFireTruck"] = true,
    ["drugs_effect"] = true,
    ["drugs_give"] = true,
    ["NET_DoPrinterAction"] = true,
    ["opr_withdraw"] = true,
    ["money_clicker_withdraw"] = true,
    ["NGII_TakeMoney"] = true,
    ["gPrinters.retrieveMoney"] = true,
    ["revival_revive_accept"] = true,
    ["chname"] = true,
    ["NewRPNameSQL"] = true,
    ["UpdateRPUModelSQL"] = true,
    ["SetTableTarget"] = true,
    ["SquadGiveWeapon"] = true,
    ["BuyUpgradesStuff"] = true,
    ["REPAdminChangeLVL"] = true,
    ["SendMail"] = true,
    ["DemotePlayer"] = true,
    ["OpenGates"] = true,
    ["VehicleUnderglow"] = true,
    ["Hopping_Test"] = true,
    ["CREATE_REPORT"] = true,
    ["CreateEntity"] = true,
    ["FiremanLeave"] = true,
    ["DarkRP_Defib_ForceSpawn"] = true,
    ["Resupply"] = true,
    ["BTTTStartVotekick"] = true,
    ["_nonDBVMVote"] = true,
    ["REPPurchase"] = true,
    ["deathrag_takeitem"] = true,
    ["FacCreate"] = true,
    ["InformPlayer"] = true,
    ["lockpick_sound"] = true,
    ["SetPlayerModel"] = true,
    ["changeToPhysgun"] = true,
    ["VoteBanNO"] = true,
    ["VoteKickNO"] = true,
    ["shopguild_buyitem"] = true,
    ["MG2.Request.GangRankings"] = true,
    ["gMining.sellMineral"] = true,
    ["ItemStoreDrop"] = true,
    ["optarrest"] = true,
    ["UpdateAdvBoneSettings"] = true,
    ["ViralsScoreboardAdmin"] = true,
    ["PowerRoundsForcePR"] = true,
    ["showDisguiseHUD"] = true,
    ["withdrawMoney"] = true,
    ["SyncPrinterButtons76561198027292625"] = true,
    ["phone"] = true,
    ["STLoanToServer"] = true,
    ["TCBDealerStore"] = true,
    ["TCBDealerSpawn"] = true,
    ["gMining.registerAchievement"] = true,
    ["gPrinters.openUpgrades"] = true
}

function MODULE:InitializedModules()
    for name in pairs(KnownExploits) do
        net.Receive(name, function(_, client)
            client.nextExploitNotify = client.nextExploitNotify or 0
            if client.nextExploitNotify > CurTime() then return end
            client.nextExploitNotify = CurTime() + 2
            lia.log.add(client, "exploitAttempt", client:Name(), client:SteamID(), tostring(name))
            client:notifyLocalized("caughtExploiting")
            for _, p in player.Iterator() do
                if p:isStaffOnDuty() or p:hasPrivilege("receiveCheaterNotifications") then p:notifyLocalized("exploitAttempt", client:Name(), client:SteamID(), tostring(name)) end
            end
        end)
    end

    for netName in pairs(MaliciousNet) do
        if util.NetworkStringToID(netName) ~= 0 then
            lia.admin(L("backdoorDetectedConsole", netName))
            if isfunction(net.Receivers[netName]) then
                local backdoorInfos = debug.getinfo(net.Receivers[netName], "S")
                lia.admin(L("backdoorDeclaredIn", netName, backdoorInfos.short_src, backdoorInfos.linedefined))
                lia.log.add(nil, "backdoorDetected", netName, backdoorInfos.short_src, backdoorInfos.linedefined)
            else
                lia.log.add(nil, "backdoorDetected", netName)
            end

            net.Receive(netName, function(_, client)
                lia.log.add(client, "exploitAttempt", client:Name(), client:SteamID(), tostring(netName))
                for _, p in player.Iterator() do
                    if p:isStaffOnDuty() or p:hasPrivilege("receiveCheaterNotifications") then p:notifyLocalized("exploitAttempt", client:Name(), client:SteamID(), tostring(netName)) end
                end
            end)
        end
    end
end

net.Receive("CheckSeed", function(_, client)
    local sentSteamID = net.ReadString()
    if not sentSteamID or sentSteamID == "" then
        lia.notifyAdmin(L("steamIDMissing", client:Name(), client:SteamID()))
        lia.log.add(client, "steamIDMissing", client:Name(), client:SteamID())
        return
    end

    if client:SteamID() ~= sentSteamID then
        lia.notifyAdmin(L("steamIDMismatch", client:Name(), client:SteamID(), sentSteamID))
        lia.log.add(client, "steamIDMismatch", client:Name(), client:SteamID(), sentSteamID)
    end
end)

net.Receive("CheckHack", function(_, client)
    lia.log.add(client, "hackAttempt", "CheckHack")
    local override = hook.Run("PlayerCheatDetected", client)
    client:setNetVar("cheater", true)
    client:setLiliaData("cheater", true)
    hook.Run("OnCheaterCaught", client)
    if override ~= true then lia.applyPunishment(client, L("hackingInfraction"), true, true, 0, "kickedForInfractionPeriod", "bannedForInfractionPeriod") end
end)

net.Receive("VerifyCheatsResponse", function(_, client)
    lia.log.add(client, "verifyCheatsOK")
    client.VerifyCheatsPending = nil
    if client.VerifyCheatsTimer then
        timer.Remove(client.VerifyCheatsTimer)
        client.VerifyCheatsTimer = nil
    end
end)

local function getEntityDisplayName(ent)
    if not IsValid(ent) then return "Unknown Entity" end
    if ent:GetClass() == "lia_item" and ent.getItemTable then
        local item = ent:getItemTable()
        if item and item.getName then
            return item:getName()
        elseif item and item.name then
            return item.name
        end
    end

    if ent:GetClass() == "lia_vendor" then
        local vendorName = ent:getNetVar("name")
        if vendorName and vendorName ~= "" then return vendorName end
    end

    if ent:GetClass() == "lia_storage" then
        local storageInfo = ent:getStorageInfo()
        if storageInfo and storageInfo.name then return storageInfo.name end
    end

    if ent:IsPlayer() and ent:getChar() then return ent:getChar():getName() end
    if ent:IsVehicle() then
        local vehicleName = ent:GetVehicleClass()
        if vehicleName and vehicleName ~= "" then return vehicleName end
    end

    if ent.PrintName and ent.PrintName ~= "" then return ent.PrintName end
    local className = ent:GetClass()
    if className:StartWith("lia_") then return className:sub(5):gsub("_", " "):gsub("^%l", string.upper) end
    return className
end

net.Receive("liaTeleportToEntity", function(_, client)
    if not client:hasPrivilege("teleportToEntity") then
        client:notifyLocalized("noPrivilege")
        return
    end

    local entity = net.ReadEntity()
    if not IsValid(entity) then
        client:notifyLocalized("invalidEntity")
        return
    end

    client.previousPosition = client:GetPos()
    local entityPos = entity:GetPos()
    local trace = util.TraceLine({
        start = entityPos,
        endpos = entityPos + Vector(0, 0, 100),
        mask = MASK_SOLID
    })

    if trace.Hit then
        client:SetPos(trace.HitPos + Vector(0, 0, 10))
    else
        client:SetPos(entityPos + Vector(0, 0, 50))
    end

    client:notifyLocalized("teleportedToEntity", getEntityDisplayName(entity))
    lia.log.add(client, "entityTeleport", client:Name(), getEntityDisplayName(entity), tostring(entity:GetPos()))
end)

net.Receive("liaReturnFromEntity", function(_, client)
    if not client.previousPosition then
        client:notifyLocalized("noPreviousPosition")
        return
    end

    local returnPos = client.previousPosition
    client:SetPos(returnPos)
    client.previousPosition = nil
    client:notifyLocalized("returnedFromEntity")
    lia.log.add(client, "entityReturn", client:Name(), tostring(returnPos))
end)
